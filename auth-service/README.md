# Auth Service

## üîê –û–±–∑–æ—Ä

**Auth Service** ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã Task Manager. –û–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π (–≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É), –≤—ã–¥–∞—á–µ–π –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π JWT —Ç–æ–∫–µ–Ω–æ–≤, –∞ —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏—è–º–∏.

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
*   –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–æ–ª–µ–π.
*   –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –≤—ã–¥–∞—á–∞ JWT (JSON Web Tokens).
*   –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å –¥–æ—Å—Ç—É–ø–∞ (`admin`, `user`).
*   –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥ (Logout) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤.
*   –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ (Refresh Token flow).
*   –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –∏ Expvar.

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –°—Ç–µ–∫

*   **–Ø–∑—ã–∫:** Go 1.21+
*   **Web Framework:** [Gin Gonic](https://github.com/gin-gonic/gin)
*   **Database:** PostgreSQL (Driver: `pgx` via GORM)
*   **ORM:** [GORM](https://gorm.io/)
*   **Cache:** Redis (–¥–ª—è Blacklist —Ç–æ–∫–µ–Ω–æ–≤)
*   **Auth:** `golang-jwt/jwt/v4`
*   **Security:** `bcrypt` (–¥–ª—è –ø–∞—Ä–æ–ª–µ–π)

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (.env)

–°–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
# –ü–æ—Ä—Ç –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
PORT=8081

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL
# –§–æ—Ä–º–∞—Ç: user:password@host:port/dbname
DB_URL=postgres://postgres:password@postgres:5432/taskmanager?sslmode=disable

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Redis
REDIS_URL=redis://redis:6379

# –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
# –í–ê–ñ–ù–û: –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º –∏ —Å–ª–æ–∂–Ω—ã–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
JWT_SECRET=your-super-secret-jwt-key-here-make-it-very-long-and-secure
```

---

## üíæ –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ö–µ–º—É `auth_schema` –≤ PostgreSQL.

### –¢–∞–±–ª–∏—Ü–∞ `users`

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) |
| `email` | VARCHAR(255) | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `password` | VARCHAR(255) | –•–µ—à –ø–∞—Ä–æ–ª—è (Bcrypt) |
| `role` | VARCHAR(50) | –†–æ–ª—å (`user` –∏–ª–∏ `admin`) |
| `created_at`| TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `updated_at`| TIMESTAMP | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

---

## üîå API Endpoints

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
`POST /register`

–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Request:**
```json
{
  "email": "newuser@example.com",
  "password": "strongpassword123",
  "role": "user" 
}
```
*(–†–æ–ª—å "admin" –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–æ–≥–∏–∫–æ–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞–µ—Ç—Å—è "user")*

**Response (201 Created):**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOi...",
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "email": "newuser@example.com",
    "role": "user"
  }
}
```

### 2. –õ–æ–≥–∏–Ω
`POST /login`

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–∞.

**Request:**
```json
{
  "email": "newuser@example.com",
  "password": "strongpassword123"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOi...",
    "user_id": "...",
    "email": "...",
    "role": "..."
  }
}
```

### 3. –í—ã—Ö–æ–¥ (Logout)
`POST /logout`
*–¢—Ä–µ–±—É–µ—Ç Header:* `Authorization: Bearer <token>`

–ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω, –¥–æ–±–∞–≤–ª—è—è –µ–≥–æ –≤ "–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫" –≤ Redis –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –µ–≥–æ –∂–∏–∑–Ω–∏.

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "message": "Successfully logged out"
  }
}
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (Refresh)
`POST /refresh`
*–¢—Ä–µ–±—É–µ—Ç Header:* `Authorization: Bearer <token>`

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –≤–∞–ª–∏–¥–µ–Ω (–∏–ª–∏ –±–ª–∏–∑–æ–∫ –∫ –∏—Å—Ç–µ—á–µ–Ω–∏—é, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –ª–æ–≥–∏–∫–∏). –°—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ Blacklist.

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "token": "new.jwt.token...",
    ...
  }
}
```

### 5. Health Check
`GET /health`

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ë–î –∏ Redis.

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "service": "auth-service"
  }
}
```

---

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ JWT

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–æ–∫–µ–Ω–∞ (Payload)
–¢–æ–∫–µ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ Claims:
*   `user_id`: UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
*   `role`: –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
*   `exp`: –í—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è (Unix timestamp)
*   `iat`: –í—Ä–µ–º—è –≤—ã–¥–∞—á–∏

### Blacklist (Redis)
–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ª–æ–≥–∞—É—Ç–∞ (—á—Ç–æ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å stateless JWT) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Redis.
*   –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `/logout` —Ç–æ–∫–µ–Ω –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ Redis.
*   –ö–ª—é—á: `blacklist:<token_string>`
*   TTL –∫–ª—é—á–∞ —Ä–∞–≤–µ–Ω –æ—Å—Ç–∞–≤—à–µ–º—É—Å—è –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞.
*   Middleware `AuthMiddleware` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ Redis –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–µ—Ä–≤–∏—Å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è Prometheus –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ Expvar –º–µ—Ç—Ä–∏–∫–∏ Go.

*   `/metrics` ‚Äî Prometheus –º–µ—Ç—Ä–∏–∫–∏ (–∑–∞–ø—Ä–æ—Å—ã, –æ—à–∏–±–∫–∏, –ª–∞—Ç–µ–Ω—Å–∏).
*   `/debug/vars` ‚Äî –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Ä–∞–Ω—Ç–∞–π–º–∞ Go (GC, –≥–æ—Ä—É—Ç–∏–Ω—ã, –ø–∞–º—è—Ç—å).

---

## üöÄ –ó–∞–ø—É—Å–∫ –∏ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ Docker)

1.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∏ Redis –∑–∞–ø—É—â–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.
2.  –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –≤—ã—à–µ.
3.  –ó–∞–ø—É—Å—Ç–∏—Ç–µ:
    ```bash
    go mod download
    go run main.go
    ```

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
```bash
go test ./...
```
